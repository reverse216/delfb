<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Delfin Bebek</title>
    <style>
        :root { --primary: #ff9a9e; --bg-color: #fecfef; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #e0f7fa; height: 100vh; display: flex; justify-content: center; align-items: center; user-select: none; }
        #game-container { width: 100%; height: 100%; max-width: 450px; background: #fff; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* GiriÅŸ EkranÄ± */
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box input { padding: 15px; border-radius: 20px; border: 1px solid #ddd; margin-bottom: 10px; text-align: center; background: #f9f9f9; }
        .btn-main { padding: 12px 40px; background: var(--primary); color: white; border: none; border-radius: 25px; font-size: 18px; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 154, 158, 0.4); }
        
        /* Oyun ArayÃ¼zÃ¼ */
        #game-ui { display: none; height: 100%; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; }
        .stats-container { background: rgba(255,255,255,0.9); padding: 15px; border-radius: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { font-size: 14px; color: #555; display: flex; align-items: center; }
        .bar-wrapper { flex-grow: 1; height: 8px; background: #eee; border-radius: 4px; margin-left: 8px; overflow: hidden; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.5s ease; }
        
        /* Renkler */
        #hunger-bar { background: #ffadad; } 
        #hygiene-bar { background: #9bf6ff; }
        #sleep-bar { background: #bdb2ff; } 
        #fun-bar { background: #fdffb6; }

        /* Karakter AlanÄ± */
        .character-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        
        /* GIF AyarÄ±: Pixel Art olduÄŸu iÃ§in bulanÄ±klaÅŸmasÄ±n diye */
        #char-img {
            width: 200px; 
            height: 200px; 
            image-rendering: pixelated; /* Pikselleri net gÃ¶sterir */
            object-fit: contain;
        }

        /* Butonlar */
        .actions-container { display: flex; justify-content: space-around; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .action-btn { background: none; border: none; font-size: 32px; cursor: pointer; transition: transform 0.1s; padding: 10px; }
        .action-btn:active { transform: scale(0.9); }
        
        /* Durum MesajÄ± */
        #status-bar { text-align: center; font-size: 12px; color: #aaa; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="login-screen">
        <h1 style="color: #ff9a9e;">Delfin Bebek</h1>
        <div class="login-box">
            <input type="text" id="username" value="delfin" readonly>
            <br>
            <button class="btn-main" onclick="startGame()">BaÄŸlan</button>
        </div>
    </div>

    <div id="game-ui">
        <div id="status-bar">Sunucuya baÄŸlanÄ±yor...</div>
        
        <div class="stats-container">
            <div class="stat-box">ğŸ” AÃ§lÄ±k <div class="bar-wrapper"><div id="hunger-bar" class="bar-fill"></div></div></div>
            <div class="stat-box">ğŸ§¼ Temizlik <div class="bar-wrapper"><div id="hygiene-bar" class="bar-fill"></div></div></div>
            <div class="stat-box">ğŸ˜´ Uyku <div class="bar-wrapper"><div id="sleep-bar" class="bar-fill"></div></div></div>
            <div class="stat-box">ğŸ® EÄŸlence <div class="bar-wrapper"><div id="fun-bar" class="bar-fill"></div></div></div>
        </div>

        <div class="character-area">
            <img id="char-img" src="./assets/idle.gif" alt="Karakter">
        </div>

        <div class="actions-container">
            <button class="action-btn" onclick="performAction('feed', 20)">ğŸ”</button>
            <button class="action-btn" onclick="performAction('wash', 100)">ğŸ§¼</button>
            <button class="action-btn" onclick="toggleSleep()">ğŸ˜´</button>
            <button class="action-btn" onclick="performAction('play', 15)">ğŸ®</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- BURAYI KENDÄ° BÄ°LGÄ°LERÄ°NLE DOLDUR ---
     const firebaseConfig = {
    apiKey: "AIzaSyAafnX1FRRmpgZeGcsU_Y0OnvcJnNYT9tc",
    authDomain: "dlfnb-fb286.firebaseapp.com",
    databaseURL: "https://dlfnb-fb286-default-rtdb.firebaseio.com",
    projectId: "dlfnb-fb286",
    storageBucket: "dlfnb-fb286.firebasestorage.app",
    messagingSenderId: "941682911917",
    appId: "1:941682911917:web:18f53833a4cd0076a2f424"
  };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const currentUser = "delfin";
    
    let localStats = {}; 
    let isActionPlaying = false; 
    let animationTimeout; 

    // Oyunu BaÅŸlat
    window.startGame = function() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        
        const starCountRef = ref(db, 'users/' + currentUser);
        onValue(starCountRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStats = data;
                
                // --- Ä°ÅTE SÄ°HÄ°RLÄ° DOKUNUÅ BURADA ---
                // Veri ilk yÃ¼klendiÄŸinde "Offline HesaplamasÄ±" yapÄ±yoruz
                calculateOfflineProgress(data.lastSaveTime);

                updateUI(localStats);
                document.getElementById('status-bar').innerText = "ğŸŸ¢ CanlÄ± BaÄŸlantÄ±";
            } else {
                resetData();
            }
        });

        setInterval(gameLoop, 5000); // 5 saniyede bir dÃ¼ÅŸsÃ¼n (TarayÄ±cÄ± aÃ§Ä±kken)
    }

    // --- EKSÄ°K OLAN FONKSÄ°YON BU ---
    // Site kapalÄ±yken geÃ§en sÃ¼reyi hesaplayÄ±p statlarÄ± dÃ¼ÅŸÃ¼rÃ¼r
    // Site kapalÄ±yken geÃ§en sÃ¼reyi hesaplayan DÃœZELTÄ°LMÄ°Å fonksiyon
    function calculateOfflineProgress(lastTime) {
        if (!lastTime) return;

        const now = Date.now();
        const diffSeconds = Math.floor((now - lastTime) / 1000); // Saniye farkÄ±
        
        // Test iÃ§in 10 saniyeden fazla kapalÄ± kalÄ±rsa hesaplasÄ±n (CanlÄ±da bunu 60 yapabilirsin)
        if (diffSeconds > 10) {
            console.log("Site kapalÄ±yken geÃ§en sÃ¼re (sn):", diffSeconds);

            // FORMÃœL: Her 10 dakikada (600sn) 1 birim deÄŸiÅŸim olsun
            // HÄ±zlÄ± test etmek istersen 600 yerine 10 yazabilirsin.
            const changeAmount = Math.floor(diffSeconds / 600); 

            if (changeAmount > 0) {
                // 1. AÃ‡LIK, TEMÄ°ZLÄ°K ve EÄLENCE her tÃ¼rlÃ¼ azalÄ±r (Uyusa da uyanÄ±k olsa da acÄ±kÄ±r)
                localStats.hunger = Math.max(localStats.hunger - changeAmount, 0);
                localStats.hygiene = Math.max(localStats.hygiene - changeAmount, 0);
                localStats.fun = Math.max(localStats.fun - changeAmount, 0);

                // 2. KRÄ°TÄ°K NOKTA: UYKU MANTIÄI
                if (localStats.isSleeping === true) {
                    // EÄŸer uyuyorsa: Uyku puanÄ± ARTAR (Enerji dolar)
                    // Hatta uykudayken daha hÄ±zlÄ± dolsun diye changeAmount'u 2 ile Ã§arptÄ±m.
                    localStats.sleep = Math.min(localStats.sleep + (changeAmount * 2), 100);
                    
                    console.log(`Bebek uyuyordu, enerji doldu: +${changeAmount * 2}`);
                } else {
                    // EÄŸer uyanÄ±ksa: Uyku puanÄ± AZALIR (Yorulur)
                    localStats.sleep = Math.max(localStats.sleep - changeAmount, 0);
                    
                    console.log(`Bebek uyanÄ±ktÄ±, yoruldu: -${changeAmount}`);
                }
                
                // Åimdiki zamanÄ± kaydet
                localStats.lastSaveTime = now;

                // Firebase'i gÃ¼ncelle
                set(ref(db, 'users/' + currentUser), localStats);
            }
        }
    }

    function resetData() {
        const initialData = {
            hunger: 100, hygiene: 100, sleep: 100, fun: 100,
            isSleeping: false,
            lastSaveTime: Date.now()
        };
        set(ref(db, 'users/' + currentUser), initialData);
    }

    window.performAction = function(type, amount) {
        if (!localStats) return;
        if (localStats.isSleeping && type !== 'sleep') {
            alert("Uyurken iÅŸlem yapamazsÄ±n! Ã–nce uyandÄ±r.");
            return;
        }

        if (type === 'feed') localStats.hunger = Math.min(localStats.hunger + amount, 100);
        if (type === 'wash') localStats.hygiene = 100;
        if (type === 'play') {
            localStats.fun = Math.min(localStats.fun + amount, 100);
            localStats.sleep = Math.max(localStats.sleep - 10, 0); 
        }
        
        localStats.lastSaveTime = Date.now();
        set(ref(db, 'users/' + currentUser), localStats);
        playAnimation(type);
    }

    window.toggleSleep = function() {
        if (!localStats) return;
        localStats.isSleeping = !localStats.isSleeping;
        localStats.lastSaveTime = Date.now();
        set(ref(db, 'users/' + currentUser), localStats);
    }

    function playAnimation(actionType) {
        const img = document.getElementById('char-img');
        isActionPlaying = true; 
        
        let gifName = 'idle';
        if (actionType === 'feed') gifName = 'eating';
        if (actionType === 'wash') gifName = 'washing';
        if (actionType === 'play') gifName = 'eating'; 

        img.src = `./assets/${gifName}.gif`;

        if (animationTimeout) clearTimeout(animationTimeout);

        animationTimeout = setTimeout(() => {
            isActionPlaying = false;
            updateCharacterState(); 
        }, 3000);
    }

    function updateCharacterState() {
        if (isActionPlaying) return; 

        const img = document.getElementById('char-img');
        let nextGif = 'idle'; 

        if (localStats.isSleeping) {
            nextGif = 'sleeping';
        }
        else if (localStats.sleep < 20) {
            nextGif = 'sleepy';
        }
        else if (localStats.hunger < 30) {
            nextGif = 'hungry';
        }
        else if (localStats.hygiene < 40) {
            nextGif = 'dirty';
        }

        const currentSrc = img.src;
        if (!currentSrc.includes(nextGif + '.gif')) {
            img.src = `./assets/${nextGif}.gif`;
        }
    }

    function updateUI(stats) {
        document.getElementById('hunger-bar').style.width = stats.hunger + '%';
        document.getElementById('hygiene-bar').style.width = stats.hygiene + '%';
        document.getElementById('sleep-bar').style.width = stats.sleep + '%';
        document.getElementById('fun-bar').style.width = stats.fun + '%';
        updateCharacterState(); 
    }

    function gameLoop() {
        if (!localStats.hunger) return;

        if (localStats.isSleeping) {
            localStats.sleep = Math.min(localStats.sleep + 2, 100); 
            localStats.hunger = Math.max(localStats.hunger - 0.5, 0); 
        } else {
            localStats.hunger = Math.max(localStats.hunger - 1, 0);
            localStats.hygiene = Math.max(localStats.hygiene - 0.5, 0);
            localStats.sleep = Math.max(localStats.sleep - 0.5, 0);
            localStats.fun = Math.max(localStats.fun - 1, 0);
        }
        
        // Loop iÃ§indeki kaydetmeyi kapattÄ±m ki sÃ¼rekli veritabanÄ±nÄ± yormasÄ±n
        // Sadece ekranda gÃ¼ncellensin, kullanÄ±cÄ± butonlara basÄ±nca veya
        // site kapanÄ±p aÃ§Ä±lÄ±nca kaydetsin daha saÄŸlÄ±klÄ±.
        // Ama "Benim internetim bol" diyorsan alttaki satÄ±rÄ± aÃ§abilirsin:
        // set(ref(db, 'users/' + currentUser), localStats);
        
        updateUI(localStats);
    }

</script>
</body>

</html>


